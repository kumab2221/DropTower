# アーキテクチャ設計

このドキュメントはアーキテクチャの方針と、DDDコンセプトをUE5にどう対応させるかの意思決定を記述します。  
「なぜこの構造か」を残すためのADR（アーキテクチャ決定記録）的な位置づけです。

---

## アーキテクチャ方針

オニオンアーキテクチャを UE5 Blueprint の範囲で可能な限り適用します。  
**依存の向きは常に内側へ。外側のレイヤーは内側を知るが、逆はない。**

```
┌──────────────────────────────────────────────────────────┐
│  ⑤ Presentation（Actor / GameMode / Widget）             │
│  ┌────────────────────────────────────────────────────┐  │
│  │  ④ Infrastructure（SaveGame / BP_GameInstance）    │  │
│  │  ┌──────────────────────────────────────────────┐  │  │
│  │  │  ③ Application（BPI_* インターフェース）      │  │  │
│  │  │  ┌────────────────────────────────────────┐  │  │  │
│  │  │  │  ② DomainService（BFL_* 純粋関数）     │  │  │  │
│  │  │  │  ┌──────────────────────────────────┐  │  │  │  │
│  │  │  │  │  ① Domain（Struct / Enum / DT）  │  │  │  │  │
│  │  │  │  └──────────────────────────────────┘  │  │  │  │
│  │  │  └────────────────────────────────────────┘  │  │  │
│  │  └──────────────────────────────────────────────┘  │  │
│  └────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────┘
```

---

## UE5 BP における意図的な妥協点

Blueprint はDIフレームワークや抽象クラスの表現力に限界があります。  
以下は意図的な割り切りであり、バグや設計ミスではありません。

| 妥協点 | 理由 |
|---|---|
| DIコンテナは存在しない。`BP_GameInstance` が Composition Root を兼務する | UE5 BP にはDIコンテナが存在しないため、GameInstance を唯一の組み立て場所とすることで代替する |
| UseCase クラスを設けず、GameMode が Application Service を兼務する | BP でレイヤーを増やしすぎると参照関係が複雑になり保守コストが上がるため省略する |
| `SetGamePaused` を物理制御の手段として直接使用する | UE5エンジンの責務として許容し、物理制御の抽象化レイヤーは設けない |

---

## DDDコンセプト → UE5フレームワーク マッピング

| DDD概念 | UE5実装 | 配置レイヤー |
|---|---|---|
| 集約ルート: 皿 | BP_Plate（Actor）+ BP_GM_Gameplay（不変条件監視） | Presentation |
| Entity: ブロック | BP_Block（Actor、SimulatePhysics=true） | Presentation |
| Entity: プレイ記録 | S_PlayRecord（Struct） | Domain |
| VO: ブロック形状 | DT_BlockShapes（DataTable）行 + StaticMesh参照 | Domain |
| VO: 生成場所 | Float（X座標）カーソル位置から取得 | Presentation |
| VO: 積み上げ高さ | Float（計算値）BFL_ScoreCalculator が算出 | DomainService |
| VO: ゲーム状態 | E_GameState（Enum）BP_GS_Gameplay で保持 | Domain |
| VO: ブロック落下状態 | E_BlockState（Enum）BP_Block で保持 | Domain |
| DS: 物理シミュレーション | UE5 Chaos Physics（組み込み）。SetGamePaused で制御 | Infrastructure相当 |
| DS: スコア算出 | BFL_ScoreCalculator（Function Library・Pure関数） | DomainService |
| DS: ランキングルール | BFL_RankingRule（Function Library・Pure関数） | DomainService |
| Domain Event | EventDispatcher（BP_GM_Gameplay） | Presentation |
| 集約: ランキング | BP_RankingRepository（BPI_RankingRepository を実装） | Infrastructure |
| Application Service | BP_GM_Gameplay（GameMode が兼務） | Presentation |
| リポジトリ抽象 | BPI_RankingRepository（Blueprint Interface） | Application |

---

## コンテキスト内部設計（集約 / エンティティ / 値オブジェクト）

### ゲームプレイコンテキスト

**集約: ゲーム**

```
┌──────────────────────────────────────────────────────────┐
│  集約ルート: 皿                                            │
│  属性                                                     │
│   - 幅        : 長さ（VO）                                 │
│   - ゲーム状態 : ゲーム状態（VO）                           │
│  管理するEntity                                           │
│   - ブロック群 : ブロック（Entity）のコレクション            │
│  責務                                                     │
│   - ブロックが皿の外に出たことを検知し、ゲームオーバーに遷移  │
│   - ゲーム状態に応じて物理シミュレーションの停止・再開を制御  │
│                                                           │
│  ┌─────────────────────────────────────────────────────┐  │
│  │  Entity: ブロック                                    │  │
│  │  属性                                               │  │
│  │   - ID       : ブロックID（識別子）                  │  │
│  │   - 形状     : ブロック形状（VO）                    │  │
│  │   - 位置     : 座標（VO）                            │  │
│  │   - 速度     : 速度ベクトル（VO）                    │  │
│  │   - 落下状態 : ブロック落下状態（VO）                 │  │
│  │  ライフサイクル                                      │  │
│  │   生成 → [落下中] → 着地済み                         │  │
│  │                  └→ 落下済み（皿の外へ）             │  │
│  └─────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────┘
```

**Value Object 一覧**

| VO名 | 定義・制約 |
|---|---|
| ブロック形状 | ランダムに決まる多角形の頂点座標リスト（不変） |
| 生成場所 | ブロック落下開始の水平座標X（ユーザが指定） |
| 座標 | (X, Y) の2次元位置。物理シミュレーションで更新 |
| 速度ベクトル | (vX, vY) の速度。物理シミュレーションで更新 |
| 積み上げ高さ | 皿表面を0とした最高ブロック頂点までの垂直距離 |
| ゲーム状態 | ゲームプレイ中 / Pose中 / ゲームオーバー |
| ブロック落下状態 | 落下中 / 着地済み / 落下済み |

---

### ランキングコンテキスト

**集約: ランキング**

```
┌──────────────────────────────────────────────────────────┐
│  集約ルート: ランキング                                    │
│  管理するEntity                                           │
│   - プレイ記録 : プレイ記録（Entity）のリスト（最大10件）   │
│  責務                                                     │
│   - プレイ記録をスコア降順で保持する                       │
│   - 11件目以降は最下位スコアの記録を除外する               │
│                                                           │
│  ┌─────────────────────────────────────────────────────┐  │
│  │  Entity: プレイ記録                                  │  │
│  │  属性                                               │  │
│  │   - ID       : プレイ記録ID（識別子）                 │  │
│  │   - ユーザ名  : ユーザ名（VO）                        │  │
│  │   - 日時     : 日時（VO）                             │  │
│  │   - スコア   : スコア（VO）                           │  │
│  │  ライフサイクル                                      │  │
│  │   生成（ゲームオーバー時）→ ランキングに永続化          │  │
│  └─────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────┘
```

**Value Object 一覧**

| VO名 | 定義・制約 |
|---|---|
| スコア | 非負整数。ゲームプレイコンテキストの積み上げ高さを変換した値 |
| ユーザ名 | 文字列。空文字・空白のみは不可 |
| 日時 | ゲームオーバーになった時刻のタイムスタンプ |

---

### ナビゲーション（アプリケーション層）

ドメインオブジェクトは持たない。Application Service として両コンテキストを呼び出し、画面遷移を制御する。

**Application Service 一覧**

| Service名 | 責務 |
|---|---|
| ゲーム開始サービス | ゲームプレイCtxを初期化しゲーム画面へ |
| ポーズサービス | ゲームプレイCtxにPose指示を送る |
| ゲーム再開サービス | ゲームプレイCtxにPose解除を送る |
| トップ画面復帰サービス | ゲームプレイCtxを破棄しトップ画面へ |
| ランキング表示サービス | ランキングCtxからデータ取得しスコア画面へ |
