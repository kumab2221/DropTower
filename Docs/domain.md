# ドメインモデル

## ユビキタス言語

| 用語 | 定義 |
|------|------|
| 皿 | ブロックを積み上げる土台となるオブジェクト。皿の上にブロックが乗ることで積み上げが成立する |
| ブロック | 皿の上に積み上げるランダムな形状を持つオブジェクト |
| ランダムな形 | ブロックが生成される際にランダムに決定される形状 |
| 積み上げる | ブロックを皿または既存のブロックの上に重ねること |
| 落ちる | ブロックが皿の外に出て落下すること。ゲームオーバーの条件となる |
| ゲームオーバー | ブロックが皿から落ちた際にゲームが終了する状態 |
| スコア | ゲームオーバー時における、皿の表面から最も高いブロックの頂点までの高さ |
| 積み上げ高さ | 皿の表面を基準（0）とした、ブロックの積み上げの垂直方向の距離。スコアの計測単位 |
| 生成場所 | ユーザが指定する、ブロックが落下を開始する水平位置 |
| Pose（ポーズ） | ゲーム中にユーザが能動的にゲームを一時停止させる状態 |
| 物理シミュレーション | ブロックの落下・衝突・積み上げを計算するシステム。Pose中は停止する |
| トップ画面 | ゲーム起動時に表示される最初の画面。スタートボタンとスコアボタンを持つ |
| スタートボタン | トップ画面に配置され、押下するとゲーム画面に遷移するボタン |
| スコアボタン | トップ画面に配置され、押下するとスコア画面に遷移するボタン |
| トップに戻るボタン | Pose中に表示され、押下するとトップ画面に遷移するボタン |
| ゲーム画面 | ブロックを積み上げるメインのゲームプレイが行われる画面 |
| スコア画面 | 過去のプレイ記録をランキング形式で表示する画面 |
| ランキング | スコアの高い順に10位までのプレイ記録を並べたリスト |
| プレイ記録 | 名前・日時・スコアの組み合わせで構成される、1回のゲームプレイの結果 |
| 名前 | プレイ記録に紐づくプレイヤーの識別名。スコア画面のランキングに表示される |
| 日時 | プレイ記録が作成された（ゲームオーバーになった）年月日と時刻 |
| 遷移 | 画面から画面へ切り替わること（例：トップ画面→ゲーム画面） |

---

## Domain Model

### Aggregate

#### ゲーム
 - 皿とその上に載るブロック群を管理
 - ブロックが皿から落ちたことを検知し、「皿から落ちた」イベントを発行する

#### ランキング
 - プレイ記録のリスト管理
 - 「最大10件のスコア降順」の整合性を保証

### Entity
#### Block
 - 形状
 - 位置

#### プレイ記録
 - ユーザ名、日時、スコア（一回のプレイ結果）
 - ゲームオーバー時に生成される

#### Value Object

| VO名 | 説明 |
|---|---|
| ブロック形状 | ブロックごとにランダムに決まる形状の定義（不変） |
| 生成場所 | ブロックが落下を開始する水平座標（ユーザが指定） |
| 積み上げ高さ | 皿の表面を基準（0）とした垂直距離。スコアの計測単位 |
| スコア | ゲームオーバー時の積み上げ高さの値 |
| ユーザ名 | プレイ記録に紐づくプレイヤーの識別名 |
| 日時 | プレイ記録が作成された年月日と時刻 |
| ブロック落下状態 | 落下中 / 着地済み / 落下済み の3値をとる、ブロック個別の状態 |

---

### Domain Service（ドメインサービス）

**物理シミュレーション**
- ブロックの落下・衝突・着地を計算する
- 停止・再開の制御はアプリケーション層が行う

**スコア算出**
- ゲームオーバー時に皿からの積み上げ高さを計算し、スコアとして返す
- 着地済みブロックのみを対象とし、落下中のブロックは除外する


### Domain Event（ドメインイベント）

| イベント | 発生タイミング |
|---|---|
| ブロックが生成された | 新しいブロックが生成場所に出現したとき |
| ブロックが着地した | ブロックが皿または他のブロックに着地したとき |
| ブロックが皿から落ちた | ブロックが皿の外に出たとき（ゲームオーバーのトリガー） |
| ゲームオーバーになった | ゲーム状態がゲームオーバーに遷移したとき |
| ゲームがポーズされた | ゲーム状態がPose中に遷移したとき |
| ゲームが再開された | Pose中からゲームプレイ中に遷移したとき |
| スコアが記録された | プレイ記録がランキングに保存されたとき |

---

### ルール（不変条件）

- ブロックが皿から落ちたら、ゲームオーバーに遷移する
- スコアは、ゲームオーバー時の着地済みブロックによる積み上げ高さとする
- ランキングはスコアの高い順に最大10件とする
- Pose中は物理シミュレーションを停止する
- Pose中はブロックを生成できない

## 境界づけられたコンテキスト（Bounded Context）

### コンテキスト一覧

```
┌─────────────────────────────────────────────────────────────┐
│  ゲームプレイコンテキスト（コアドメイン）                        │
│                                                             │
│  責務: ブロックの生成・落下・積み上げ・ゲーム進行の管理           │
│                                                             │
│  含む概念                                                    │
│   皿 / ブロック / ブロック形状 / 生成場所 / 積み上げ高さ          │
│   物理シミュレーション / ブロック落下状態                        │
│                                                             │
│  ※ゲーム状態（Playing/Paused/GameOver）はアプリケーション層が管理 │
│                                                             │
│  発行するイベント                                             │
│   ブロックが生成された                                        │
│   ブロックが着地した                                          │
│   ブロックが皿から落ちた                                      │
│   ゲームオーバーになった ← スコア（積み上げ高さ）を含む          │
│   ゲームがポーズされた / ゲームが再開された                     │
└──────────────────────────┬──────────────────────────────────┘
                            │ ゲームオーバーになった
                            │ （スコアを含む Published Event）
                            ▼  [Upstream → Downstream]
┌─────────────────────────────────────────────────────────────┐
│  ランキングコンテキスト（支持サブドメイン）                       │
│                                                             │
│  責務: プレイ結果の永続化・ランキングの管理と表示               │
│                                                             │
│  含む概念                                                    │
│   プレイ記録 / ランキング / スコア / ユーザ名 / 日時            │
│                                                             │
│  購読するイベント                                             │
│   ゲームオーバーになった → プレイ記録を生成しランキングに保存    │
│                                                             │
│  発行するイベント                                             │
│   スコアが記録された                                          │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  ナビゲーション（アプリケーション層）                            │
│                                                             │
│  責務: 画面遷移の制御・ゲーム状態の管理                        │
│        （ゲームドメインの知識は持たない）                       │
│                                                             │
│  含む概念                                                    │
│   ゲーム状態 / トップ画面 / ゲーム画面 / スコア画面             │
│   スタートボタン / スコアボタン / トップに戻るボタン / 遷移      │
│                                                             │
│  役割: 両コンテキストを画面として組み合わせるオーケストレーター   │
│        ゲーム状態に応じて物理シミュレーションの停止・再開を指示  │
└─────────────────────────────────────────────────────────────┘
```

---

### コンテキスト間の関係（Context Map）

| 関係 | 統合パターン |
|---|---|
| ゲームプレイ[U] → ランキング[D] | Published Language（イベント経由）。スコア（積み上げ高さ）を変換して渡す |
| ナビゲーション → 両コンテキスト | Conformist（各コンテキストのAPIを直接利用） |

---

### 「スコア」の言語の違いに注意

同じ用語でもコンテキストによって意味が微妙に異なります。コンテキスト境界での変換が必要です。

| コンテキスト | スコアの意味 |
|---|---|
| ゲームプレイ | 皿からの積み上げ高さ（計測値・一時的） |
| ランキング | プレイ記録の一部として永続化された値 |